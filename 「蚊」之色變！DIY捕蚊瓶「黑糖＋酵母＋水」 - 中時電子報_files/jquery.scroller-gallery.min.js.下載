"use strict";(function(n){n.fn.scrollerGallery=function(t,i,r){var u=n.Deferred();return r&&r.push(u.promise()),this.each(function(){var y={toShowMainPhoto:!0,defaultIndex:1,scrollerOrientation:"horizontal",scrollStep:6,transitionType:1,toRotate:!1,interval:6e3,toPushState:!1,stateIndexKey:"scrollerGallery",stateIndexField:{field:"captionTitle",className:".caption-title"}},r=n.extend({},y,i),h=r.toShowMainPhoto,k=r.defaultIndex,tt=r.indexKey,it=r.indexField,f=r.scrollerOrientation,s=r.scrollStep,nt=r.transitionType,d=r.toRotate,g=r.toPushState,o=r.stateIndexKey,v=r.stateIndexField,b=r.interval,c=t.length,l,a=/[\s\`\~\!\@\#\$\%\^\&\*\(\)\-\_\=\+\[\{\]\}\\\|\;\:\'\"\,\<\.\>\/\?]/g,e=function(t){return n("<div>"+t+"</div>").text()},p=function(i){var r=n(i),c=function(){var t=n.Deferred();window.frontEndSpecialized?t.resolve():n.ajax({url:"//cache.chinatimes.com/scripts/front-end-specialized.js",dataType:"script",crossDomain:!0,success:function(){t.resolve()}}),n.when(t.promise()).done(function(){l(),h()})},l=function(){var t='<div class="scroller-gallery" data-state-index-field="'+v.className+'" data-state-index-key="'+o+'"><div class="stage-container '+f+'"><div class="main-photo"><div class="cropper"><div class="main-photo-container"><span></span></div><div class="caption expanded"><div class="bgn"></div><h1 class="caption-title"></h1><p class="caption-text"></p><span class="pointer"></span></div></div></div><div class="photo-scroller"><div class="photo-scroller-cropper"><ul class="item-group"></ul></div><div class="btn"><a class="btn-prev" href="javascript:;"></a></div><div class="btn"><a class="btn-next" href="javascript:;"></a></div></div></div></div>';n(t).appendTo(r)},h=function(){var f=r.find(".item-group"),i="";n.each(t,function(){u(this),i+='<li class="item-entry"><div class="thumb-photo"><div class="cropper"><span></span><a title="'+e(this.captionTitle)+'" href="javascript:;" data-link-url="'+this.linkUrl+'" data-link-target="'+this.linkTarget+'"><img src="'+this.photoUrl+'" alt="'+e(this.captionTitle)+'" data-photo-url="'+this.photoUrl+'" data-large-photo-url="'+this.largePhotoUrl+'" data-media-type="'+this.mediaType+'" class="photo" /></a></div></div><div class="caption"><h3 class="caption-title" data-caption-title="'+e(this.captionTitle)+'">'+(this.linkUrl?'<a href="'+this.linkUrl+'" target="'+this.linkTarget+'">':"")+this.captionTitle+(this.linkUrl?"</a>":"")+'</h3><p class="caption-text" data-caption-text="'+e(this.captionText)+'">'+this.captionText+'</p></div><span class="pointer"></span></li>'}),n(i).appendTo(f),f.find(".item-entry").eq(0).addClass("first"),s(r)},u=function(t){var i,r=[{name:"youtube",urlMatchPattern:"www.youtube.com/watch",getId:function(n){for(var u=n.split("?")[1].split("&"),i=0,f=u.length,t,r;i<f;i+=1){t=u[i];if(t.split("=")[0]==="v")return r=t.split("=")[1]}},getThumbImage:function(n,t){var r=this.getId(n),t=t===-1?Math.ceil(Math.random()*3):t;return"http://img.youtube.com/vi/"+r+"/"+t+".jpg"},getEmbedCode:function(n,t,i){var u=this.getId(n),t=t||720,i=i||480;return"<iframe width='"+t+"' height='"+i+"' src='http://www.youtube.com/embed/"+u+"?wmode=transparent' frameborder='0' allowfullscreen></iframe>"}}];n.each(r,function(){if(t.largePhotoUrl.indexOf(this.urlMatchPattern)>-1)return i=this,!1});if(i){t.mediaType="video";switch(i.name){case"youtube":t.photoUrl=t.photoUrl||i.getThumbImage(t.largePhotoUrl,-1),t.largePhotoUrl=i.getEmbedCode(t.largePhotoUrl,"100%","100%")}}else t.mediaType||(t.mediaType="photo")},s=function(n){frontEndSpecialized(n,function(){w(i)})};c()},w=function(i){var ai=n(i),et=ai.find(".scroller-gallery"),wt=et.find(".stage-container"),nt=et.find(".main-photo"),ii=nt.find(".cropper"),it=nt.find(".caption"),lt=et.find(".photo-scroller"),ui=lt.find(".photo-scroller-cropper"),tt=et.find(".item-group"),ot=tt.find(".item-entry"),ft=et.find(".btn a"),ti=et.find("a.btn-prev"),ni=et.find("a.btn-next"),at=ii.width(),dt=ii.height(),li=ui.width(),vi=ui.height(),pi=tt.width(),yi=tt.height(),ct=ot.filter(":last-child").outerWidth(!0),ht=ot.filter(":last-child").outerHeight(!0),pt=Math.max(pi-li,0),yt=Math.max(yi-vi,0),vt,w,kt={},bt=[],ut=prefixStyleProperty("transform"),gt=prefixStyleProperty("transformOrigin"),st=prefixStyleProperty("transition"),rt=prefixStyleProperty("transitionDuration"),ri=function(){return n(window).height()},p={isMouseDown:!1,startX:0,startY:0,currentX:0,currentY:0,endX:0,endY:0,deltaX:0,deltaY:0},ci=function(){nt.on({setVisible:function(){nt.show(),wt.removeAttr("style")},setHidden:function(){nt.hide(),f==="horizontal"?wt.css("paddingTop",0):wt.css("paddingLeft",0)},changePhoto:function(t,i){var r=[];r.push('<div class="main-photo-container">'),r.push("<span></span>"),i.mediaType==="video"?r.push(i.largePhotoUrl):(i.linkUrl&&r.push('<a href="'+i.linkUrl+'" target="'+i.linkTarget+'" title="'+i.captionTitle+'">'),r.push('<img src="'+i.largePhotoUrl+'" alt="'+i.captionTitle+'" class="'+i.className+'" />'),i.linkUrl&&r.push("</a>")),r.push("</div>"),n(r.join("")).hide().prependTo(ii),nt.trigger("getPhotoOrientation")},getPhotoOrientation:function(){imgSpecialized(nt,function(){var n=nt.find("img"),i=n.attr("data-aspect-ratio"),t=at/dt;i<t?n.addClass("rel-v"):n.addClass("rel-h"),nt.trigger("transEffect")})},transEffect:function(){var u=et.find(".main-photo-container").eq(1),i=et.find(".main-photo-container").eq(0),n=r.transitionType,t=function(){return Math.floor(Math.random()*bt.length)+1};n===0&&(n=t());if(i.find("iframe").length>0)while(n===3||n===4)n=t();kt[bt[n-1]](u,i)},changeCaption:function(n,t){var r=t.captionTitle,i=t.captionText;t.linkUrl&&(r='<a href="'+t.linkUrl+'" target="'+t.linkTarget+'">'+r+"</a>",i=i+'<a href="'+t.linkUrl+'" target="'+t.linkTarget+'" class="more">詳全文</a>'),it.stop().animate({opacity:0,bottom:"+=10px"},250,function(){it.find("h1").html(r),it.find("p").html(i),it.delay(250).animate({opacity:1,bottom:"-=10px"},250,function(){it.removeAttr("style")})})},mousedown:function(n){n.preventDefault(),p.isMouseDown=!0,p.startX=n.clientX,p.startY=n.clientY},mousemove:function(n){if(!p.isMouseDown)return!1;p.currentX=n.clientX,p.currentY=n.clientY,p.deltaX=p.currentX-p.startX,p.deltaY=p.currentY-p.startY},mouseup:function(n){p.isMouseDown=!1,p.endX=n.clientX,p.endY=n.clientY,p.deltaX=p.endX-p.startX,p.deltaY=p.endY-p.startY,nt.trigger("updateContents")},touchstart:function(n){var t=n.originalEvent.targetTouches[0];p.startX=t.clientX,p.startY=t.clientY},touchmove:function(n){var t=n.originalEvent.targetTouches[0];if(n.originalEvent.touches.length>1)return!1;p.currentX=t.clientX,p.currentY=t.clientY,p.deltaX=p.currentX-p.startX,p.deltaY=p.currentY-p.startY,Math.abs(p.deltaX)>Math.abs(p.deltaY)&&n.preventDefault()},touchend:function(n){var t=n.originalEvent.changedTouches[0];p.endX=t.clientX,p.endY=t.clientY,p.deltaX=p.endX-p.startX,p.deltaY=p.endY-p.startY,nt.trigger("updateContents")},click:function(t){var i=n(t.target);Math.abs(p.deltaX)<10?i.parents().is(it)&&(it.toggleClass("expanded collapsed"),st||(it.is(".expanded")?it.css({left:"-100%"}).animate({left:0},300):it.css({left:0}).animate({left:"-100%"},300))):t.preventDefault()},updateContents:function(){p.deltaX>30&&w-1<c&&ot.eq(w+1-1).trigger("click",[!1,!0]),p.deltaX<-30&&w-1>0&&ot.eq(w-2).trigger("click",[!1,!0])}});nt.on({dragstart:function(n){n.preventDefault()}},"img, a");it.on({click:function(n){n.stopPropagation()}},"a");tt.on({setCurrent:function(){n(this).addClass("current").siblings(".current").removeClass("current")},getPhotoData:function(){var t=n(this),r=t.find(".photo"),u=t.find("a"),f=t.find(".caption-title"),e=t.find(".caption-text"),i={className:r.attr("class"),mediaType:r.attr("data-media-type"),largePhotoUrl:r.attr("data-large-photo-url"),linkUrl:u.attr("data-link-url"),linkTarget:u.attr("data-link-target"),captionTitle:f.attr("data-caption-title"),captionText:e.attr("data-caption-text")};h&&nt.is(":visible")?nt.trigger("changePhoto",[i]).trigger("changeCaption",[i]):t.trigger("setLink",[i])},setLink:function(n,t){t.linkUrl&&(t.linkTarget==="_blank"?window.open(t.linkUrl):t.linkTarget==="_top"&&(window.location.href=t.linkUrl))},click:function(t,i,r){var u=n(this);t.preventDefault(),vt=ot.filter(".current").index()+1,w=u.index()+1;if(h&&w===vt)return!1;u.trigger("setCurrent").trigger("getPhotoData").trigger("pushState",[i]),r&&lt.trigger("scrollToCurrent")},pushState:function(i,r){var f,s,h,u;if(!g||r)return!1;f=window.History,s=e(t[w-1][v.field]),h=s.replace(a,""),u={title:document.title,url:n.query.SET(o,h)};if(history.pushState)history.pushState(u,u.title,u.url);else if(f.pushState)f.pushState(u,u.title,u.url);else return!1}},".item-entry");lt.on({scrollToNext:function(){var t,r,n,i;f==="horizontal"?(t=Math.round(tt.position().left/ct)*ct,r=Math.min(pt-Math.abs(t),ct*s),tt.stop().css("left",t).animate({left:"-="+r},300,function(){ft.trigger("updateStatus")})):(n=Math.round(tt.position().top/ht)*ht,i=Math.min(yt-Math.abs(n),ht*s),tt.stop().css("top",n).animate({top:"-="+i},300,function(){ft.trigger("updateStatus")}))},scrollToPrev:function(){var t,r,n,i;f==="horizontal"?(t=Math.round(tt.position().left/ct)*ct,r=Math.min(Math.abs(t),ct*s),tt.stop().css("left",t).animate({left:"+="+r},300,function(){ft.trigger("updateStatus")})):(n=Math.round(tt.position().top/ht)*ht,i=Math.min(Math.abs(n),ht*s),tt.stop().css("top",n).animate({top:"+="+i},300,function(){ft.trigger("updateStatus")}))},scrollToCurrent:function(){var t,n;f==="horizontal"&&pt>0?(t=Math.min((w-1)*ct,pt),tt.stop().animate({left:-t},300,function(){ft.trigger("updateStatus")})):f==="vertical"&&yt>0?(n=Math.min((w-1)*ht,yt),tt.stop().animate({top:-n},300,function(){ft.trigger("updateStatus")})):ft.trigger("updateStatus")}});ni.on({click:function(){n(this).is(".disabled")||lt.trigger("scrollToNext")}});ti.on({click:function(){n(this).is(".disabled")||lt.trigger("scrollToPrev")}});ft.on({updateStatus:function(){var t=parseInt(tt.position().left,10),n=parseInt(tt.position().top,10);f==="horizontal"?(ni.toggleClass("disabled",t===-pt),ti.toggleClass("disabled",t===0)):(ni.toggleClass("disabled",n===-yt),ti.toggleClass("disabled",n===0))}});wt.on({"mouseenter touchstart":function(){oi()},mouseleave:function(){fi()}})},hi=function(){var t;kt={fxCrossFade:function(n,t){n.stop().fadeOut(600,function(){n.remove()}),t.stop().fadeIn(600)},fxSlideHorizontal:function(n,t){var u=n.get(0),i=t.get(0),r=w>vt?at:-at;st?(u.style[rt]="500ms",u.style[ut]="translate("+-r+"px, 0)",setTimeout(function(){n.remove()},500),t.show(),i.style[rt]="0ms",i.style[ut]="translate("+r+"px, 0)",ri(),i.style[rt]="500ms",i.style[ut]="translate(0, 0)"):(n.stop().animate({left:"-="+r},500,function(){n.remove()}),t.css({left:r,display:"block"}).stop().animate({left:0},500))},fxWeaveHorizontal:function(t,i){for(var l=i.html(),s=8,u=at,h=dt/s,c=0,a=u,f=0,v=0,r=0,o="",e=0;e<s;e+=1)o+='<div class="slice">'+l+"</div>";n(o).appendTo(i.empty()),st?t.stop().fadeOut(300,function(){t.remove()}):t.remove(),i.show().find(".slice").each(function(t){var i=this,e=n(this);c=h*t,f=h*(t+1),r=t%2==0?u:-u,e.css({clip:"rect("+c+"px, "+a+"px, "+f+"px, "+v+"px)"}),st?(i.style[rt]="0ms",i.style[ut]="translate("+r+"px, 0)",ri(),i.style[rt]="600ms",i.style[ut]="translate(0, 0)"):e.css("left",r).animate({left:0},600)})},fxGridWave:function(t,i){for(var y=i.html(),r=5,a=8,f=at/r,u=dt/a,v=0,e=0,o=0,l=0,c="",p=w<vt?"":"-",s=0,h=r*a;s<h;s+=1)c+='<div class="slice">'+y+"</div>";n(c).appendTo(i.empty()),t.remove(),i.show().find(".slice").each(function(t){var i=this,s=n(this);v=u*Math.floor(t/r),e=f*(Math.floor(t%r)+1),o=u*(Math.floor(t/r)+1),l=f*Math.floor(t%r),s.css({opacity:0,clip:"rect("+v+"px, "+e+"px, "+o+"px, "+l+"px)"}),st&&(i.style[rt]="0ms",i.style[ut]="scale(1.5) translate("+p+f*.5+"px, -"+u*.5+"px)",i.style[gt]=e-f*.5+"px "+(o-u*.5)+"px"),setTimeout(function(){st?(i.style[rt]="300ms",s.css("opacity",1),i.style[ut]="scale(1) translate(0, 0)"):s.animate({opacity:1},300)},500/h*t)})},fxCrossRotate:function(n,t){var r=n.get(0),i=t.get(0);st?(r.style[rt]="800ms",r.style[gt]="-50% -50%",r.style[ut]="rotate(-90deg)",setTimeout(function(){n.remove()},800),t.show(),i.style[rt]="0ms",i.style[gt]="150% 150%",i.style[ut]="rotate(-90deg)",ri(),i.style[rt]="800ms",i.style[ut]="rotate(0deg)"):kt[bt[y.transitionType-1]](n,t)}};for(t in kt)bt.push(t)},si=function(){var i=ei(o),s,f,u=function(){return k===0?Math.ceil(Math.random()*c):parseInt(r.defaultIndex,10)};i?(s=i.replace(a,""),n.each(t,function(n){return f=e(this[v.field]).replace(a,""),f===s?(w=n+1,!1):void 0}),w||(w=u())):w=u(),h&&nt.is(":visible")?(history.pushState?ot.eq(w-1).trigger("click",[!1,!0]):ot.eq(w-1).trigger("click",[i!==null,!0]),fi()):h||(nt.trigger("setHidden"),ft.trigger("updateStatus"),lt.trigger("scrollToCurrent"))},ei=function(n){var f=window.location.href,r,t=0,e,i,u;if(f.indexOf("?")>-1)for(r=f.split("?")[1].split("&"),e=r.length;t<e;t+=1){i=r[t];if(i.split("=")[0]===n)return u=decodeURIComponent(i.split("=")[1])}else return null},fi=function(){d&&(l=setInterval(function(){w=(w+1)%c,ot.eq(w-1).trigger("click",[!1,!0])},b),n(document).data(o+"Timer",l))},oi=function(){clearInterval(l)};ci(),hi(),si(),u.resolve(o)};p(this)})}})(jQuery)