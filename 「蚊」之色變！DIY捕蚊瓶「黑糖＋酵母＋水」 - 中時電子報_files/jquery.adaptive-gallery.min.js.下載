"use strict";!function(t){t.fn.adaptiveGallery=function(e,i,a){var n=t.Deferred();return a&&a.push(n.promise()),this.each(function(){var a,o,r=t.extend({},{stageAspectRatio:1.5,defaultIndex:1,toShowCaptionOnSmallScreen:!0,isCaptionCompacted:!1,isCaptionCollapsable:!1,isCaptionLandAside:!1,toShowDateTime:!1,toShowClicks:!1,toShowReadMoreButton:!1,readMoreButtonText:"閱讀全文",infiniteLoopMode:!1,toRotate:!1,interval:6e3,toLazyLoadPhoto:!0,toAutoPlayVideo:!0,toPushState:!1,stateIndexKey:"adaptiveGallery",stateIndexField:{field:"captionTitle",className:".caption-title"}},i),s=r.stageAspectRatio,l=r.defaultIndex,d=r.toShowCaptionOnSmallScreen,c=r.isCaptionCompacted,u=r.isCaptionCollapsable,h=r.isCaptionLandAside,p=r.toShowDateTime,g=r.toShowClicks,f=r.toShowReadMoreButton,m=r.readMoreButtonText,v=r.infiniteLoopMode,w=r.toLazyLoadPhoto,b=r.toAutoPlayVideo,C=r.toRotate,y=r.interval,k=r.toPushState,T=r.stateIndexKey,A=r.stateIndexField,S=e.length,x="ontouchstart"in document&&(navigator.maxTouchPoints||"Win32"!==navigator.platform),P=/[\s\`\~\!\@\#\$\%\^\&\*\(\)\-\_\=\+\[\{\]\}\\\|\;\:\'\"\,\<\.\>\/\?]/g,X=function(e){return t("<div>"+e+"</div>").text()},I=[],Y=function(i){var p,g,f,m,Y,U=t(i).find(".adaptive-gallery:last"),M=U.find(".stage-container"),D=U.find(".item-group"),E=D.find(".item-entry"),R=E.find(".caption"),q=U.find(".navigation"),z=q.find(".position-indicator"),V=q.find(".btn"),L=q.find(".btn-prev"),j=q.find(".btn-next"),B=t(window),H=l,O={isMouseDown:!1,startX:0,startY:0,currentX:0,currentY:0,endX:0,endY:0,deltaX:0,deltaY:0},N=function(t){var e,i,a,n=window.location.href,o=0;if(!(n.indexOf("?")>-1))return null;for(i=(e=n.split("?")[1].split("&")).length;o<i;o+=1)if((a=e[o]).split("=")[0]===t)return decodeURIComponent(a.split("=")[1])},F=function(){C&&(a=setInterval(function(){var t;(H+=1)>S&&(t=1,H=1),z.find("li").eq(H-1).trigger("click",[!1,t])},y),t(document).data(T+"Timer",a))},K=function(){clearInterval(a)};M.on({init:function(t){t.stopPropagation(),M.trigger("setSize"),setTimeout(function(){E.trigger("setPhotoRelativeAspectRatio")},100)},setSize:function(){f=U.width(),m=f/s,h&&f<768&&(m*=1.5),M.css({"min-height":"",height:m}).removeClass("extra-large large medium-large medium small extra-small"),f>=1024?M.addClass("extra-large"):f<1024&&f>=768?M.addClass("large"):f<768&&f>=480?M.addClass("medium-large"):f<480&&f>=360?M.addClass("medium"):f<360&&f>=320?M.addClass("small"):M.addClass("extra-small")},mouseenter:function(){x||(V.trigger("show"),clearTimeout(Y))},mouseleave:function(){x||V.trigger("hide")}}),D.on({click:function(e,i){i&&(H=t(this).index()+1,v&&(H-1==0?H=S:H-=1),z.find("li").eq(H-1).trigger("click",[!0]))}},".item-entry"),D.on({scrollToPointer:function(){var t=100*(H+(v?1:0)-1-O.deltaX/f);D.css({left:-t+"%",transition:"none"})},scrollToCurrent:function(t,e,i){var a;switch(e){case 1:a=v?100*(H+S):0;break;case-1:a=0;break;default:a=100*(H+(v?1:0)-1)}i?D.css("transition","none"):D.css("transition",""),D.css({left:-a+"%"}),setTimeout(function(){e&&D.css({left:-100*(v?1===e?1:S:0)+"%",transition:"none"})},600)}}),D.on({mousedown:function(t){t.preventDefault(),O.isMouseDown=!0,O.startX=t.clientX,O.startY=t.clientY},mousemove:function(e){if(!O.isMouseDown)return!1;O.currentX=e.clientX,O.currentY=e.clientY,O.deltaX=O.currentX-O.startX,O.deltaY=O.currentY-O.startY,t(this).trigger("moveContents")},mouseup:function(e){O.isMouseDown=!1,O.endX=e.clientX,O.endY=e.clientY,O.deltaX=O.endX-O.startX,O.deltaY=O.endY-O.startY,t(this).trigger("updateContents")},touchstart:function(t){var e=t.originalEvent.targetTouches[0];O.startX=e.clientX,O.startY=e.clientY},touchmove:function(e){var i=e.originalEvent.targetTouches[0];if(e.originalEvent.touches.length>1)return!1;O.currentX=i.clientX,O.currentY=i.clientY,O.deltaX=O.currentX-O.startX,O.deltaY=O.currentY-O.startY,Math.abs(O.deltaX)>Math.abs(O.deltaY)&&e.preventDefault(),t(this).trigger("moveContents")},touchend:function(e){var i=e.originalEvent.changedTouches[0];O.endX=i.clientX,O.endY=i.clientY,O.deltaX=O.endX-O.startX,O.deltaY=O.endY-O.startY,t(this).trigger("updateContents")},moveContents:function(){if(H+(v?1:0)-1==0&&O.deltaX>0||H===S+(v?1:0)&&O.deltaX<0||1===S)return!1;D.trigger("scrollToPointer")},updateContents:function(){var t=0;if(1===S)return!1;O.deltaX<-50?v?((H+=1)>S&&(t=1,H=1),z.find("li").eq(H-1).trigger("click",[!1,t])):H-1<S&&z.find("li").eq(H+1-1).trigger("click"):O.deltaX>50?v?((H-=1)<1&&(t=-1,H=S),z.find("li").eq(H-1).trigger("click",[!1,t])):H-1>0&&z.find("li").eq(H-1-1).trigger("click"):D.trigger("scrollToCurrent")},click:function(e){var i=t(e.target);Math.abs(O.deltaX)<10?i.parents().is(R)&&!c&&u&&!h&&i.trigger("toggleStatus"):e.preventDefault()},setPhotoRelativeAspectRatio:function(){var e=t(this).find(".cropper"),i=e.width(),a=e.height(),n=i/a;e.attr({"data-width":i,"data-height":a,"data-aspect-ratio":n}),imgSpecialized(e,n)},loadLazyPhoto:function(){var e=t(this),i=e.find(".photo");w&&"photo"===e.attr("data-media-type")&&!e.is(".ready")&&(i.attr("src",i.attr("data-large-photo-url")),i.one({load:function(){e.addClass("ready"),frontEndSpecialized(e,function(){e.trigger("setPhotoRelativeAspectRatio"),e.data("photoAlignCenter")&&e.photoAlignCenter()})}}))},pauseVideo:function(){var e,i,a=t(this).find("[data-vendor-name]");if(a.length)switch(e=a.attr("data-vendor-name"),i=a.attr("id"),e){case"youtube":a.get(0).contentWindow.postMessage(a.attr("data-command-pause"),"*");break;case"facebook":t.each(I,function(t,e){e.id===i&&e.instance.pause()})}},playVideo:function(){var e,i,a=t(this).find("[data-vendor-name]");if(a.length)switch(e=a.attr("data-vendor-name"),i=a.attr("id"),e){case"youtube":setTimeout(function(){a.get(0).contentWindow.postMessage(a.attr("data-command-play"),"*")},1e3);break;case"facebook":t.each(I,function(t,e){e.id===i&&setTimeout(function(){e.instance.play()},1e3)})}}},".item-entry"),D.on({dragstart:function(t){t.preventDefault()}},"img, a"),R.on({init:function(e){var i=t(this),a=i.parents(".container"),n=U.width(),o=JSON.parse(i.attr("data-to-show-caption"));if(e.stopPropagation(),!o||!d&&n<480)return i.hide(),!1;i.show(),h&&(n<768?(a.removeClass("caption-land-aside"),n<480?i.removeClass("land-aside"):i.addClass("land-aside")):(a.addClass("caption-land-aside"),i.addClass("land-aside"))),i.trigger("showHideInnerBlocks")},showHideInnerBlocks:function(){var e=t(this),i=e.find(".caption-container"),a=e.find("time"),n=e.find(".clicks"),o=e.find(".caption-text"),r=e.find(".btn-more"),s=[r,a,n,o],l=[o,n,a,r];for(h||(s=[o,a,r],l=[r,a,o]);i.outerHeight(!0)<=e.height()&&s.length;)s.shift().show();for(;i.outerHeight(!0)>e.height()&&l.length;)l.shift().hide()},toggleStatus:function(){t(this).toggleClass("expanded collapsed")}}),q.on({init:function(e,i){var a=t(this);e.stopPropagation(),1===S?a.hide():V.trigger("init",[i])}}),V.on({init:function(e,i){e.stopPropagation(),i||x||(t(this).trigger("show"),clearTimeout(Y),Y=setTimeout(function(){V.trigger("hide")},1e4))},show:function(){t(this).removeClass("hide").addClass("show")},hide:function(){t(this).removeClass("show").addClass("hide")},updateStatus:function(){if(v)return!1;H-1==0?(L.removeClass("hover").addClass("disabled"),o&&L.find("a").trigger("swapHoverImage",[!1])):L.removeClass("disabled"),H===S?(j.removeClass("hover").addClass("disabled"),o&&j.find("a").trigger("swapHoverImage",[!1])):j.removeClass("disabled")}}),V.on({"mouseenter touchstart":function(){var e=t(this),i=e.parent();if(i.is(".disabled"))return!1;i.addClass("hover"),o&&e.trigger("swapHoverImage",[!0])},touchmove:function(){t(this).parent().removeClass("hover")},mouseleave:function(){var e=t(this);e.parent().removeClass("hover"),o&&e.trigger("swapHoverImage",[!1])},swapHoverImage:function(e,i){var a=t(this).find("img"),n=a.attr("src");i?a.attr("src",n.replace(".png","-hover.png")):a.attr("src",n.replace("-hover.png",".png"))},click:function(){var e=t(this),i=e.parent(),a=0;if(i.is(".disabled"))return!1;i.is(j)?(H+=1)>S&&(a=1,H=1):(H-=1)<1&&(a=-1,H=S),x&&setTimeout(function(){i.removeClass("hover")},600),z.find("li").eq(H-1).trigger("click",[!1,a]),e.trigger("updateStatus")}},"a"),z.on({click:function(e,i,a,n){var o=t(this);H=o.index()+1,D.trigger("scrollToCurrent",[a,n]),V.trigger("updateStatus"),o.trigger("updateStatus").trigger("pushState",[i]),t.each([H,H+1],function(t,e){e>=1&&e<=S&&(v&&(2===(e+=1)&&E.eq(0).trigger("loadLazyPhoto"),e===S+1&&E.eq(S+1).trigger("loadLazyPhoto")),E.eq(e-1).trigger("loadLazyPhoto"))}),E.filter('[data-media-type="video"]').trigger("pauseVideo"),b&&(v?E.eq(H-1+1).trigger("playVideo"):E.eq(H-1).trigger("playVideo"))},updateStatus:function(){t(this).addClass("current").siblings().removeClass("current")},pushState:function(i,a){var n,o,r,s;if(!k||a)return!1;if(n=window.History,o=X(e[H-1][A.field]),r=o.replace(P,""),s={title:document.title,url:t.query.SET(T,r)},history.pushState)history.pushState(s,s.title,s.url);else{if(!n.pushState)return!1;n.pushState(s,s.title,s.url)}}},"li"),M.on({"mouseenter touchstart":function(){K()},mouseleave:function(){F()}}),U.on({init:function(t,e){t.stopPropagation(),M.trigger("init"),R.trigger("init"),q.trigger("init",[e])}}).trigger("init"),B.on({resize:function(){p===B.width()&&g===B.height()||(p=B.width(),g=B.height(),U.trigger("init",[!0]))}}),function(){var i,a,n=N(T),o=function(){return 0===l?Math.ceil(Math.random()*S):parseInt(r.defaultIndex,10)};n?(i=n.replace(P,""),t.each(e,function(t){if((a=X(this[A.field]).replace(P,""))===i)return H=t+1,!1}),H||(H=o())):H=o(),z.find("li").eq(H-1).trigger("click",[!1,void 0,!0])}(),F(),n.resolve(T)};!function(i){var a=t(i),n=function(){var e="";o=navigator.userAgent.indexOf("Trident")>-1&&!1===prefixStyleProperty("transform"),e+='<div class="adaptive-gallery'+(x?" is-touch-device":"")+'" data-state-index-field="'+A.className+'" data-state-index-key="'+T+'"><div class="stage-container" style="min-height: 0;"><div class="stage-cropper"><ul class="item-group"></ul><div class="navigation"><ol class="position-indicator"></ol><div class="btn btn-prev '+(x?"show":"hide")+'"><a href="javascript:;">&lt;</a></div><div class="btn btn-next '+(x?"show":"hide")+'"><a href="javascript:;">&gt;</a></div></div></div></div></div>',a.append(e),o&&a.find(".navigation .btn a").each(function(){var e=t(this),i=e.css("background-image").split(",")[0].replace('url("',"").replace(".svg)",".png");e.addClass("alternative").html('<img src="'+i+'">')})},r=function(){var i=a.find(".item-group"),n=a.find(".position-indicator"),o=[],r=[],d=t.extend([],e);v&&(d.unshift(e[S-1]),d.push(e[0])),t.each(d,function(e){!function(e){var i,a,n=[{name:"youtube",urlMatchPattern:[/www.youtube.com\/watch/i,/youtu.be/i,/www.youtube.com\/embed/i],getId:function(t){var e,i,n,o;switch(a){case 0:for(n=(e=t.split("?")[1].split("&")).length,i=0;i<n;i+=1)if("v"===(o=e[i]).split("=")[0])return o.split("=")[1];break;case 1:return t.split(".be/")[1].split("?")[0];case 2:for(n=(e=t.split(" ")).length,i=0;i<n;i+=1)if("src"===(o=e[i]).split("=")[0])return o.split("=")[1].split("/embed/")[1].replace('"',"")}},getThumbImage:function(t,e){var i=this.getId(t);return e=-1===e?Math.ceil(3*Math.random()):e,"https://img.youtube.com/vi/"+i+"/"+e+".jpg"},getEmbedCode:function(t,e,i){var a=this.getId(t);return e=e||"100%",i=i||"100%","<iframe width='"+e+"' height='"+i+"' src='https://www.youtube.com/embed/"+a+'?wmode=transparent&enablejsapi=1&rel=0\' frameborder=\'0\' allowfullscreen data-vendor-name=\'youtube\' data-command-pause=\'{"event": "command", "func": "pauseVideo"}\' data-command-play=\'{"event": "command", "func": "playVideo"}\'></iframe>'}},{name:"facebook",urlMatchPattern:[/www.facebook.com/i],getId:function(t){switch(a){case 0:return t.split("/videos/")[1].replace("/","")}},getThumbImage:function(t){return"https://graph.facebook.com/"+this.getId(t)+"/picture"},getEmbedCode:function(t,e,i){var a=this.getId(t);return e=e||"",i=i||"",'<div id="'+a+'" class="fb-video" data-width="'+e+'" style="height: '+i+'" data-allowfullscreen="true" data-href="'+t+'" data-vendor-name="facebook"></div>'}}];if(t.each(n,function(){var n=this;t.each(n.urlMatchPattern,function(t,o){if(o.test(e.largePhotoUrl))return i=n,a=t,!1})}),i)switch(e.mediaType="video",i.name){case"youtube":e.photoUrl=e.photoUrl||i.getThumbImage(e.largePhotoUrl,-1),e.largePhotoUrl=i.getEmbedCode(e.largePhotoUrl);break;case"facebook":e.photoUrl=e.photoUrl||i.getThumbImage(e.largePhotoUrl),e.largePhotoUrl=i.getEmbedCode(e.largePhotoUrl)}else e.mediaType||(e.mediaType="photo")}(this),o.push('<li class="item-entry'+(!0===this.toShowVideoIcon?" video":"")+'" data-media-type="'+this.mediaType+'">'),o.push('<div class="container'+(h?" caption-land-aside":"")+'">'),o.push('<div class="cropper">'),"photo"===this.mediaType?(o.push('<a href="'+this.linkUrl+'" target="'+this.linkTarget+'" title="'+X(this.captionTitle)+'" data-link-url="'+this.linkUrl+'" data-link-target="'+this.linkTarget+'">'),w&&l!==(w?e:e+1)?o.push('<img class="photo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" alt="'+X(this.captionTitle)+'" data-photo-url="'+this.photoUrl+'" data-large-photo-url="'+this.largePhotoUrl+'" data-media-type="'+this.mediaType+'">'):o.push('<img class="photo" src="'+this.largePhotoUrl+'" alt="'+X(this.captionTitle)+'" data-photo-url="'+this.photoUrl+'" data-large-photo-url="'+this.largePhotoUrl+'" data-media-type="'+this.mediaType+'">'),o.push("</a>")):(o.push('<div class="video-frame">'),o.push(this.largePhotoUrl),o.push("</div>")),o.push('<div class="caption'+(h?" land-aside":(u?" collapsable":"")+(c?" compacted":" expanded"))+'" data-to-show-caption="'+(!1===this.toShowCaption?"false":"true")+'">'),o.push('<div class="caption-container">'),o.push('<div class="bgn"></div>'),o.push('<h3 class="caption-title" data-caption-title="'+X(this.captionTitle)+'">'),this.linkUrl&&o.push('<a href="'+this.linkUrl+'" target="'+this.linkTarget+'">'),o.push(this.captionTitle),this.linkUrl&&o.push("</a>"),o.push("</h3>"),o.push('<div class="meta-info">'),this.captionDateTime&&p&&o.push('<time datetime="'+this.captionDateTime+'">'+this.captionDateTime+"</time>"),this.clicks&&g&&h&&(o.push('<div class="clicks">'),o.push("點閱：<span>"+this.clicks+"</span>"),o.push("</div>")),o.push("</div>"),this.captionText&&o.push('<p class="caption-text" data-caption-text="'+X(this.captionText)+'">'+this.captionText+"</p>"),c||!u||h||o.push('<span class="pointer"></span>'),f&&o.push('<div class="btn-more"><a href="'+this.linkUrl+'" target="'+this.linkTarget+'">'+m+"</a></div>"),o.push("</div>"),o.push("</div>"),this.clicks&&g&&!h&&(o.push('<div class="clicks">'),o.push('<a title="點閱數" href="'+this.linkUrl+'" target="'+this.linkTarget+'">'+this.clicks+"</a>"),o.push("</div>")),o.push("</div>"),o.push("</div>"),o.push("</li>"),(!v||0!==e&&e!==S+1)&&r.push('<li><a href="javascript:;">'+(e+1)+"</a></li>")}),i.append(o.join("")),n.append(r.join("")),s(a)},s=function(t){frontEndSpecialized(t,function(){Y(a)})};!function(){var e=t.Deferred();window.frontEndSpecialized?e.resolve():t.ajax({url:"//cache.chinatimes.com/scripts/front-end-specialized.min.js",dataType:"script",crossDomain:!0,success:function(){e.resolve()}}),t.when(e.promise()).done(function(){window.fbAsyncInit=function(){FB.init({xfbml:!0,version:"v2.5"}),FB.Event.subscribe("xfbml.ready",function(t){"video"===t.type&&I.push({id:t.id,instance:t.instance})})},n(),r()})}()}(this)})}}(jQuery);